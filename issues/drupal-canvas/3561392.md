# #3561392: Test Canvas on Drupal 11.3

- **Project:** Drupal Canvas
- **Type:** Critical task
- **Version:** 1.x-dev
- **Status:** Fixed
- **Diff:** [e52a1ea](https://git.drupalcode.org/project/canvas/-/commit/e52a1ea44d7b1c860e63a70865382d157d6a532c) · +160/-50 prod · +344/-108 test · +13/-32 infra · 102 files
- **Discussion:** [#3561392](https://www.drupal.org/node/3561392) · 5 contributors · 42 comments

## Summary

Canvas now fully supports Drupal 11.3, ensuring the site builder works correctly with the latest Drupal core release. This update includes fixes for upstream changes in Drupal core, addresses new deprecations in Symfony 7.4, and adjusts test expectations to account for changes in block plugin configuration between Drupal 11.2 and 11.3. The Canvas continuous integration system now tests both 11.2 and 11.3 to maintain compatibility across versions.

## Impact

No upgrade or configuration changes required.

## Technical details

This issue added comprehensive Drupal 11.3 compatibility testing and fixed multiple failures caused by upstream changes. The primary driver of changes was core issue #3547808, which made the `label_display` block configuration value non-translatable and changed its config schema from `type: label` to `type: string` with Choice and NotBlank constraints. This altered component version hashes throughout Canvas because `ComponentSourceBase::generateVersionHash()` includes the schema definitions in normalized data.

The team updated hundreds of test fixtures to change `label_display` values from boolean `FALSE` to string `'0'` to match the new schema. Tests in `ComponentInputsEvolutionTest` required special handling because component version hashes differ between 11.2 and 11.3 due to the config schema changes. The solution uses `match` statements to provide version-specific expected hashes.

Additional changes addressed Symfony 7.4 deprecations by updating constraint instantiation from shorthand notation to explicit array syntax (e.g., `addConstraint('StringSemantics', ['semantic' => StringSemanticsConstraint::PROSE])` instead of passing the constant directly). The `#[RunTestsInSeparateProcesses]` attribute was added to 80+ kernel and functional tests to prevent class redeclaration errors when running the full test suite on 11.3.

The `.gitlab-ci.yml` now includes a dedicated `phpunit (11.3)` job that runs on every merge request, ensuring Canvas doesn't regress on 11.3 support. The original `phpunit` job continues testing 11.2 as Canvas's minimum supported version.

## Timeline

- Opened: December 4, 2025
- First commit: January 7, 2026 (1 month later)
- Last commit: February 16, 2026 (1 month later)

## Collaboration

phenaproxima shepherded this complex compatibility effort over six weeks, methodically working through test failures caused by upstream changes and figuring out the root causes of obscure hash mismatches in version tracking. penyaskito provided the breakthrough for handling version-dependent test expectations by implementing core version detection with `match` statements, then completed the painful merge when conflicts accumulated. Wim Leers conducted thorough review of all 150 changed files to ensure no test coverage was lost and created two follow-up issues to address systemic problems discovered during the work.

## Lessons learned

- When maintaining compatibility across multiple major versions of a dependency, testing against development branches introduces CI instability from upstream changes. Pin to concrete release tags to ensure reproducible builds and avoid unexpected breakage. *(via wim leers)*
- When testing infrastructure code (like component versioning), avoid testing with invalid input data. Validation would prevent invalid data in production, so testing against it obscures real issues and wastes debugging time. *(via wim leers)*
- When abstracting away default values from users, don't store those defaults in the database. Omit them during save and restore just-in-time to reduce storage overhead and simplify upgrades when defaults change. *(via wim leers)*
- When a system generates hashes from configuration that includes schema definitions, upstream schema changes (like new constraints or type refinements) will change those hashes even if the data remains identical. Version-specific test assertions or normalization strategies are needed to handle cross-version compatibility. *(via penyaskito, wim leers)*

---

*This summary is AI-generated and may contain errors. Check the [original issue on Drupal.org](https://www.drupal.org/node/3561392) for the full picture. For more digests, see [Drupal Digests](https://github.com/dbuytaert/drupal-digests/).*
