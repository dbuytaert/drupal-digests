# #3571997: CI: auto-retry known random Cypress E2E failures + PHPUnit's dreaded "RecursiveDirectoryIterator failed to open directory" (since Drupal 11.2) + ComponentAudit DB-dependent result order + Playwright flakiness

- **Project:** Drupal Canvas
- **Type:** Critical task
- **Version:** 1.x-dev
- **Status:** Fixed
- **Diff:** [db17f6d](https://git.drupalcode.org/project/canvas/-/commit/db17f6dd327f2d5ede1d45723ab1b7d4a716f385) · +121/-5 prod · +21/-5 test · +91/-5 infra · 12 files
- **Discussion:** [#3571997](https://www.drupal.org/node/3571997) · 4 contributors · 51 comments

## Summary

Canvas contributors spent months manually re-running CI jobs when random infrastructure failures made tests fail. This change adds automatic retry logic that detects known intermittent failures and re-runs only those jobs, cutting down on developer frustration and wasted time. The solution addresses PHPUnit directory errors that started in Drupal 11.2, flaky Cypress end-to-end tests, database-specific sorting inconsistencies, and Playwright browser test flakiness. Developers working on Canvas no longer need to babysit CI pipelines.

## Impact

No upgrade or configuration changes required.

## Technical details

This change implements GitLab CI automatic retry logic for four categories of known intermittent failures in the Canvas project's test infrastructure. The approach uses custom `after_script` commands that grep test output logs for known failure patterns, then exit with code 112 to trigger a retry via `retry: exit_codes: 112` configuration.

For PHPUnit tests, the main culprit is `RecursiveDirectoryIterator::__construct` failing to open directories in the simpletest working directory. This race condition appeared after Drupal 11.2 and affects 97% of random PHPUnit failures. The solution duplicates `.phpunit-base`'s `script` section from `gitlab_templates` to capture exit codes, greps the PHPUnit XML output files for the error pattern, and exits with 112 to trigger auto-retry (max 2 attempts).

For Cypress E2E tests, the solution pipes output to `cypress.log` and greps for specific test file failures like `global-regions-interact.cy.js`. For Playwright tests, it detects "1 failed" in the output, which indicates a single-browser failure rather than a systemic problem across all three browsers.

Two additional bugs were fixed to reduce false failures: `ComponentAudit::getContentRevisionIdsUsingComponentIds()` now sorts results in PHP after querying rather than at the database level, avoiding MySQL/MariaDB/PostgreSQL sort order differences. A forward-port of the fix for [#2862699](https://www.drupal.org/project/drupal/issues/2862699) enables proper multi-field sorting for config entity queries via `ConfigEntityQuery` and `ConfigEntityQueryFactory` classes in `src/CoreBugFix/`.

## Timeline

- Opened: February 6, 2026
- First commit: February 10, 2026 (3 days later)
- Last commit: February 19, 2026 (9 days later)

## Collaboration

Wim Leers drove this work after months of manually retrying CI jobs, building the auto-retry infrastructure piece by piece as new failure patterns emerged. Jonathan Smith (jonathan1055) reviewed the GitLab CI mechanics and suggested improvements to make the logic more maintainable, including proposing upstream changes to `gitlab_templates` in [#3572371](https://www.drupal.org/project/gitlab_templates/issues/3572371). Jesús Olalla (penyaskito) identified the database sorting root cause and reviewed the ComponentAudit fix. Jesse Baker approved the Playwright auto-retry strategy after seeing repeated single-browser flakes.

## Lessons learned

- When CI tests fail randomly due to upstream issues (race conditions in dependencies, infrastructure load), auto-retry logic with failure pattern matching prevents manual intervention overhead. Detect known failure signatures in test output and exit with a specific code that triggers conditional retry, allowing developers to focus on real regressions rather than clicking retry buttons. *(via wim leers)*
- When test failures depend on database-specific sort order (e.g., different behavior between MySQL and MariaDB on unspecified sorts), enforce deterministic ordering in application code rather than relying on database implementation details. Sort in PHP if the dataset is small, or add explicit ORDER BY clauses at the database layer with tie-breakers. *(via wim leers, penyaskito)*

---

*This summary is AI-generated and may contain errors. Check the [original issue on Drupal.org](https://www.drupal.org/node/3571997) for the full picture. For more digests, see [Drupal Digests](https://github.com/dbuytaert/drupal-digests/).*
