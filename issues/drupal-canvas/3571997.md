# #3571997: CI: auto-retry known random Cypress E2E failures + PHPUnit's dreaded "RecursiveDirectoryIterator failed to open directory" (since Drupal 11.2)

- **Project:** Drupal Canvas
- **Type:** Normal task
- **Version:** 1.x-dev
- **Status:** Fixed
- **Diff:** [8ed2d0b](https://git.drupalcode.org/project/canvas/-/commit/8ed2d0bc827d742c322f193842523f8b881ee043) · +119/-1 prod · +21/-5 test · +81/-1 infra · 9 files
- **Discussion:** [#3571997](https://www.drupal.org/node/3571997) · 2 contributors · 28 comments

## Summary

The Canvas project added automatic retry logic to its GitLab CI pipeline to handle random test failures that waste developer time. Two main problems were addressed: a race condition in PHPUnit tests that causes directory errors (appearing since Drupal 11.2), and intermittent Cypress end-to-end test failures under high infrastructure load. The CI system now detects these specific known failures and automatically retries the job up to twice, eliminating the need for manual retries.

## Impact

No upgrade or configuration changes required.

## Technical details

This change adds conditional auto-retry behavior to the Canvas project's `.gitlab-ci.yml` configuration. The PHPUnit job now duplicates the upstream `gitlab_templates` project's `.phpunit-base` script section to capture the exit code, then uses `grep` to scan PHPUnit XML output files for known failure patterns like `RecursiveDirectoryIterator::__construct(...): Failed to open directory: No such file or directory`. When detected, it exits with code 112, triggering a GitLab CI retry via the `retry: { max: 2, exit_codes: 112 }` configuration.

For Cypress E2E tests, the script pipes test output to `cypress.log` using `tee`, then scans for specific failing test file patterns like `global-regions-interact.cy.js`. The same exit code 112 mechanism triggers automatic retries.

The implementation also fixes a secondary issue: database-specific sorting inconsistencies in config entity queries. This required forward-porting a fix from the nine-year-old Drupal core issue [#2862699](https://www.drupal.org/project/drupal/issues/2862699) by creating `ConfigEntityQuery` and `ConfigEntityQueryFactory` classes in `src/CoreBugFix/` that properly handle multiple sort criteria. The `CanvasServiceProvider` now decorates the `entity.query.config` service with this patched version.

A companion upstream feature request [#3572371](https://www.drupal.org/project/gitlab_templates/issues/3572371) was created to make this pattern easier to implement without duplicating the entire script section.

## Timeline

- Opened: February 6, 2026
- Committed: February 10, 2026 (3 days later)

## Collaboration

Wim Leers implemented this solution after months of manually retrying CI jobs. Jonathan Dunn (jonathan1055) provided valuable review and suggestions in comment #8-9 and #15, proposing the upstream enhancement path that led to the feature request. The issue demonstrates a pragmatic approach: implementing a working solution locally first (even if it requires duplication), then working with upstream to provide a cleaner pattern for the broader community.

## Lessons learned

- When random test failures occur frequently in CI due to infrastructure or upstream race conditions, auto-retry based on error pattern detection in after_script prevents wasted maintainer time manually retriggering jobs. Exit with a retry-specific code (e.g., 112) when detecting known patterns, but ensure the script itself (not after_script) returns that code since after_script failures don't propagate exit codes. *(via wim leers)*
- When a directory traversal error appears across multiple stack traces in different subsystems (config sync, Twig compilation, PHPUnit internals), the root cause is typically a shared race condition at the filesystem level, not bugs in each individual component. Look for common patterns across failures rather than treating each symptom separately. *(via wim leers)*

---

*This summary is AI-generated and may contain errors. Check the [original issue on Drupal.org](https://www.drupal.org/node/3571997) for the full picture. For more digests, see [Drupal Digests](https://github.com/dbuytaert/drupal-digests/).*
