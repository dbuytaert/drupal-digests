# #3571997: CI: auto-retry known random Cypress E2E failures + PHPUnit's dreaded "RecursiveDirectoryIterator failed to open directory" (since Drupal 11.2) + ComponentAudit DB-dependent result order + Playwright flakiness

- **Project:** Drupal Canvas
- **Type:** Critical task
- **Version:** 1.x-dev
- **Status:** Fixed
- **Diff:** [db17f6d](https://git.drupalcode.org/project/canvas/-/commit/db17f6dd327f2d5ede1d45723ab1b7d4a716f385) · +121/-5 prod · +21/-5 test · +91/-5 infra · 12 files
- **Discussion:** [#3571997](https://www.drupal.org/node/3571997) · 4 contributors · 52 comments

## Summary

Canvas has struggled with random test failures in continuous integration for months, forcing developers to manually retry failed jobs over and over. Most failures were not real bugs but symptoms of race conditions in upstream dependencies like PHPUnit and flaky end-to-end tests. This change automatically retries tests when known random failures occur, dramatically reducing friction for contributors. The CI pipeline now catches transient failures on the first run and retries only the affected jobs, letting real failures surface faster without manual intervention.

## Impact

No upgrade or configuration changes required.

## Technical details

This change adds automatic retry logic to Canvas's GitLab CI pipeline for PHPUnit, Cypress, and Playwright test jobs. The implementation uses GitLab CI's `retry` feature with a custom exit code (112) triggered when specific failure patterns are detected.

For PHPUnit tests, the `script` section was duplicated from the upstream `gitlab_templates` project's `.phpunit-base` to inject retry detection logic at the end. The script greps PHPUnit's XML output for `RecursiveDirectoryIterator` errors that have plagued tests since Drupal 11.2, then exits with code 112 to trigger a retry. The job configuration specifies `retry: max: 2, exit_codes: 112` to automatically rerun up to twice when that exit code appears.

Similar patterns were added for Cypress E2E tests, which pipe output to a log file and grep for specific failing test filenames like `global-regions-interact.cy.js`. Playwright tests detect `1 failed` in the output (indicating a single-browser failure rather than a systemic issue across all three browsers) and trigger the same retry mechanism.

The change also includes fixes for the underlying causes where possible. It forward-ports a fix from core issue [#2862699](https://www.drupal.org/project/drupal/issues/2862699) for config entity query multi-sort bugs into Canvas via `ConfigEntityQuery` and `ConfigEntityQueryFactory` classes. It adds secondary sorting by ID to API controllers listing config entities to ensure deterministic ordering across databases. Test fixtures were expanded to catch database-dependent sort order issues.

## Timeline

- Opened: February 6, 2026
- First commit: February 10, 2026 (3 days later)
- Last commit: February 19, 2026 (9 days later)

## Collaboration

Wim Leers drove this work after months of manually retrying failed CI jobs on Canvas. Jonathan Haynes (jonathan1055) provided early review and suggestions for working with the upstream `gitlab_templates` project, including the idea to make the exit code handling overridable upstream. Penyaskito (Ramón Vilar) reviewed the database sorting fixes and connected them to similar work in [#3562563](https://www.drupal.org/project/canvas/issues/3562563). Jesse Baker and Balint Brennan provided input on the Playwright retry thresholds.

## Lessons learned

- When CI jobs suffer from intermittent infrastructure-level failures (filesystem race conditions, flaky tests), auto-retry on specific failure patterns instead of manual retries. Use `after_script` to grep structured output (XML, logs) for known signatures, then exit with a custom code (0-255) that triggers GitLab CI's `retry: when: script_failure` mechanism. This keeps pipelines unblocked while upstream fixes arrive. *(via wim leers)*
- When database queries return results in non-deterministic order (due to lack of explicit sort or ambiguous sort keys like identical timestamps), tests that assert exact array equality will randomly fail across database engines. Always sort query results by a stable, unique key (like entity ID) in PHP if the database-level sort is insufficient, especially when the performance cost is negligible. *(via wim leers, penyaskito)*

---

*This summary is AI-generated and may contain errors. Check the [original issue on Drupal.org](https://www.drupal.org/node/3571997) for the full picture. For more digests, see [Drupal Digests](https://github.com/dbuytaert/drupal-digests/).*
