# #3566433: `Component::getVersions()` must cast all version hashes to string: 1 in 4 million probability that it fails due to all-digit version hash

- **Project:** Drupal Canvas
- **Type:** Critical bug report
- **Version:** 1.x-dev
- **Status:** Fixed
- **Diff:** [947eba8](https://git.drupalcode.org/project/canvas/-/commit/947eba85b2f60d188cd71a93bb4538a3bf87b3fb) 路 +18/-1 路 1 file
- **Discussion:** [#3566433](https://www.drupal.org/node/3566433) 路 4 contributors 路 16 comments

## Summary

In rare cases (about 1 in 4 million), component version hashes could be treated as integers instead of strings, causing fatal errors when saving components. This happened when a hash consisted entirely of digits, because PHP automatically converts all-digit array keys from strings to integers. The bug was discovered when a user encountered a fatal type error after adding a component property and clearing the cache. The fix ensures all version hashes are explicitly cast to strings.

## Impact

No upgrade or configuration changes required.

## Technical details

The `VersionedConfigEntityBase::getVersions()` method returns version hashes that are used as array keys throughout the Canvas module. Version hashes are generated using `hash('xxh64', json_encode($data))`, which produces a 16-character hexadecimal string. 

When a hash consists entirely of digits (0-9 rather than including any A-F characters), PHP automatically converts it to an integer when used as an array key. This creates a type mismatch because `Component::loadVersion()` expects a string parameter, and the component schema defines versions as strings.

The probability of an all-digit hash is (10/16)^16, or approximately 1 in 4 million, because 10 of the 16 hexadecimal characters are digits. The fix adds an `array_map()` call in `getVersions()` that explicitly casts all version values to strings, preventing PHP's automatic integer conversion. While other methods like `getActiveVersion()` and `getLoadedVersion()` already had explicit string return types, `getVersions()` was returning raw array keys that could be integers.

## Timeline

- Opened: January 8, 2026
- Committed: February 19, 2026 (1 month later)

## Collaboration

interx discovered this extremely rare edge case and investigated the root cause, tracing the problem to PHP's automatic type conversion of all-digit strings used as array keys. wim leers quickly identified the specific method that needed fixing and provided a patch within hours of the report. penyaskito committed the fix to ensure it would be merged.

---

*This summary is AI-generated and may contain errors. Check the [original issue on Drupal.org](https://www.drupal.org/node/3566433) for the full picture. For more digests, see [Drupal Digests](https://github.com/dbuytaert/drupal-digests/).*
