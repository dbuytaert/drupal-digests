# #3563216: Add a base class for kernel tests to improve DX: `CanvasKernelTestBase`

- **Project:** Drupal Canvas
- **Type:** Major task
- **Version:** 1.x-dev
- **Status:** Fixed
- **Diff:** [3d50837](https://git.drupalcode.org/project/canvas/-/commit/3d50837d857f8099f1013f03047c750d51dff0f9) · +2/-10 prod · +337/-1049 test · 79 files
- **Discussion:** [#3563216](https://www.drupal.org/node/3563216) · 2 contributors · 20 comments

## Summary

Canvas module kernel tests were verbose and difficult to maintain because each test manually installed dependencies and configured the environment. A new `CanvasKernelTestBase` class now provides a standardized starting point for kernel tests. Tests using this base class are shorter and easier to understand because common setup happens automatically. Over 60 existing tests were converted to use the new base class, removing nearly 1,000 lines of repetitive code while keeping the same test coverage.

## Impact

No upgrade or configuration changes required.

## Technical details

The new `CanvasKernelTestBase` extends Drupal core's `KernelTestBase` and automatically installs Canvas and all its direct and indirect dependencies (such as `filter`, `media`, `image`, `link`, and `ckeditor5`). It also enables strict config schema validation by default, which is normally disabled for contributed modules but critical for Canvas since it relies heavily on validation. The base class does not install content entity schemas, allowing individual tests to opt in to only the entities they need for speed.

The patch converted 60+ kernel tests to extend `CanvasKernelTestBase` instead of `KernelTestBase`, removing their `$modules` arrays and `setUp()` boilerplate. Tests that use `CanvasTestSetup` (a fixture class) could not yet be converted and are marked with `@todo` comments pointing to [#3531679](https://www.drupal.org/project/canvas/issues/3531679). The refactoring removed 992 lines of code and added 322 lines, with the new base class accounting for about 100 lines and the rest being deletions from simplified tests.

The class includes documentation explaining when to use it (all Canvas kernel tests except those testing installation) and what it does not provide (entity schemas must still be installed manually). A follow-up issue [#3572401](https://www.drupal.org/project/canvas/issues/3572401) will add PHPCS rules to prevent regressions.

## Timeline

- Opened: December 15, 2025
- Committed: February 9, 2026 (1 month later)

## Collaboration

Wim Leers shepherded this issue from a proof-of-concept by phenaproxima into a comprehensive refactoring. Phenaproxima initially prototyped the base class and reviewed Leers' expansion, which converted over 60 kernel tests to use the new base. Together they iterated on the scope: deciding which modules to pre-install, whether to install entity schemas, and how much documentation to provide. Phenaproxima's approval came after constructive discussion about tradeoffs between speed and convenience for future test authors.

## Lessons learned

- When creating a base test class that installs modules, installing entity schemas may seem convenient but significantly slows test execution. Let individual tests install only the entity schemas they need, keeping the base class fast by default. *(via phenaproxima, wim leers)*
- When refactoring a large test suite, avoid expanding scope to fix all related technical debt in one issue. Ship the foundation that enables incremental improvements, then address remaining conversions in follow-up issues. *(via wim leers)*

---

*This summary is AI-generated and may contain errors. Check the [original issue on Drupal.org](https://www.drupal.org/node/3563216) for the full picture. For more digests, see [Drupal Digests](https://github.com/dbuytaert/drupal-digests/).*
