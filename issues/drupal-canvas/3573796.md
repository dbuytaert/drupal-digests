# #3573796: `json-schema-definitions://canvas.module/stream-wrapper-uri` known prop shape is incorrectly mapped to link field type, causing error

- **Project:** Drupal Canvas
- **Type:** Normal bug report
- **Version:** 1.x-dev
- **Status:** Fixed
- **Diff:** [5f829be](https://git.drupalcode.org/project/canvas/-/commit/5f829bed6b89bbc254c90b371455f05c0e9feac8) · +31/-0 prod · +72/-0 test · 6 files
- **Discussion:** [#3573796](https://www.drupal.org/node/3573796) · 2 contributors · 16 comments

## Summary

Canvas was crashing when Single Directory Components used a JSON schema definition for file URIs (like `public://documents/report.pdf`) without specifying an image content type. The system incorrectly tried to handle these as link fields, which don't support Drupal's stream wrapper schemes. This meant components that wanted to reference files like PDFs or documents would fail with errors. The fix maps these file URI properties to the correct field type so components can safely reference non-image files stored in Drupal.

## Impact

No upgrade or configuration changes required.

## Technical details

The `json-schema-definitions://canvas.module/stream-wrapper-uri` JSON schema definition specifies a URI with `x-allowed-schemes: [public]` but no `contentMediaType`. The `JsonSchemaStringFormat::computeStorablePropShape()` method was falling through to the default case and mapping these to a `link` field type with a `url` property.

When Canvas tried to evaluate example values like `public://documents/report.pdf`, the `LinkUrl::getValue()` method called `Url::fromUri('public://...')`, which fails because stream wrapper URIs are not valid for `Url::fromUri()`. Only HTTP(S) and a few other specific schemes are supported by that method.

The fix adds a new match condition in `JsonSchemaStringFormat::computeStorablePropShape()` that checks for `x-allowed-schemes` containing `public` and no `contentMediaType`. When matched, it returns a `ReferenceFieldTypePropExpression` that maps to a `file` field type's `entity` property, then follows the reference to the `File` entity's `uri` base field and its `value` property. This mirrors the existing pattern for `stream-wrapper-image-uri` but without the image-specific handling. The field widget is set to `file_generic`.

## Timeline

- Opened: February 16, 2026
- Committed: February 17, 2026

## Collaboration

Fago reported this bug while implementing support for all Canvas JSON schema types in canvas_extjs, discovering the crash through test Vue components. Wim Leers quickly added test cases and expectations, then realized he had previously added test coverage for this exact prop shape in a different issue but had only partially diagnosed the problem. Fago implemented the matching logic to handle the stream wrapper URIs correctly, and both contributors collaborated in real-time as changes appeared in their shared branch.

## Lessons learned

- When mapping generic URI formats to field types, validate that the chosen field type's API supports the URI scheme before committing to the mapping. Stream wrapper URIs (like public://) are not compatible with Drupal's Url::fromUri(), which expects standard web protocols, causing runtime crashes when link field types attempt to process them. *(via fago, wim leers)*

---

*This summary is AI-generated and may contain errors. Check the [original issue on Drupal.org](https://www.drupal.org/node/3573796) for the full picture. For more digests, see [Drupal Digests](https://github.com/dbuytaert/drupal-digests/).*
