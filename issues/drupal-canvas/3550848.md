# #3550848: Linker works for `type: string, format: date-time`, but `DateTimeDefaultWidget` renders the linker twice

- **Project:** Drupal Canvas
- **Type:** Major bug report
- **Version:** 1.x-dev
- **Status:** Fixed
- **Diff:** [789863d](https://git.drupalcode.org/project/canvas/-/commit/789863d0e54093c63ed9547b067df467ae6a01ed) · +46/-5 · 5 files
- **Discussion:** [#3550848](https://www.drupal.org/node/3550848) · 3 contributors · 11 comments

## Summary

When a datetime field was linked to a component property in Canvas, the linker icon appeared twice – once for the date input and once for the time input. This happened because the datetime widget uses a fieldset with two separate input fields, and the system was attaching a linker to each input's label instead of to the fieldset's legend. The fix ensures only one linker appears at the fieldset level, making the interface cleaner and easier to understand. The change also revealed and fixed a related issue where datetime values were stored without timezone information, preventing linked datetime properties from rendering correctly.

## Impact

No upgrade or configuration changes required.

## Technical details

The datetime field widget (`DateTimeDefaultWidget`) renders two input elements inside a fieldset – one for date and one for time. The linker system was designed to attach to form input labels, so it created two linkers for this single field.

The fix modifies `GeneratedFieldExplicitInputUxComponentSourceBase::processElementTreeLinkerLabels()` to detect when a form element has a `fieldset` theme wrapper and passes the prop link data to the fieldset via a new `#prop_link_data` property. The `canvas_stark_preprocess_fieldset()` function then JSON-encodes this data and makes it available to the template.

The `fieldset.html.twig` template was updated to use `<canvas-drupal-label>` in the legend instead of a plain `<span>`, allowing it to render the linker when `prop_link_data` is present. This approach matches the existing solution for the media library widget.

The `DrupalFormElementLabel.tsx` component was also updated to respect `titleDisplay !== 'invisible'` before rendering linkers, preventing linkers from appearing for invisible labels.

The fix surfaced a separate bug where datetime values stored without timezone information failed JSON Schema validation. A workaround was added to `Evaluator::evaluate()` for entity field expressions, appending `Z` to datetime strings that lack timezone information. This matches the existing workaround for field type expressions. The root cause is tracked separately.

## Timeline

- Opened: October 7, 2025
- Committed: February 17, 2026 (4 months later)

## Collaboration

Wim Leers opened the issue and implemented the fix, resolving a merge conflict with existing fieldset template changes from the media library work. bnjmnm identified the root cause early in the issue, explaining that linkers associate with form input labels but datetime widgets use fieldset legends instead, and noting that similar special-casing was already needed for media widgets.

## Lessons learned

- When rendering UI elements for compound widgets (like date/time pickers with multiple inputs), attach interactive metadata to the container's primary label rather than to each individual input. Attaching to every input creates duplicate UI affordances that confuse users. *(via bnjmnm)*
- When a bug is hidden behind another bug, applying an existing workaround to the newly exposed scenario enables pragmatic progress. Once the system works end-to-end, the root cause can be addressed separately without blocking users. *(via wim leers)*

---

*This summary is AI-generated and may contain errors. Check the [original issue on Drupal.org](https://www.drupal.org/node/3550848) for the full picture. For more digests, see [Drupal Digests](https://github.com/dbuytaert/drupal-digests/).*
