# #3572401: PHPCS: require CanvasKernelTestBase to be extended, forbid extending KernelTestBase

- **Project:** Drupal Canvas
- **Type:** Major task
- **Version:** 1.x-dev
- **Status:** Fixed
- **Diff:** [cfdac0c](https://git.drupalcode.org/project/canvas/-/commit/cfdac0ce82ed8382051fd863efa465bd076b9df9) · +136/-0 prod · +22/-10 test · +7/-0 infra · 12 files
- **Discussion:** [#3572401](https://www.drupal.org/node/3572401) · 2 contributors · 16 comments

## Summary

Canvas now automatically enforces that kernel tests extend the correct base class. A custom PHP CodeSniffer rule checks that kernel tests use `CanvasKernelTestBase` instead of Drupal core's generic `KernelTestBase`. This automates a code review task that previously required human reviewers to catch and explain repeatedly. The rule allows documented exceptions for tests that have specific reasons to use a different base class, such as tests that install Canvas through a recipe.

## Impact

No upgrade or configuration changes required.

## Technical details

The Canvas project added a custom PHPCS sniff (`Canvas\Sniffs\Tests\KernelTestBaseSniff`) that runs during continuous integration to enforce the use of `CanvasKernelTestBase` in all kernel tests located in `tests/src/Kernel/` directories. This builds on [#3563216](https://www.drupal.org/project/canvas/issues/3563216), which introduced `CanvasKernelTestBase` to encode best practices and improve developer experience.

The sniff examines each test class, parses its `extends` clause, and resolves the fully qualified class name of the base class. It reports an error if a kernel test extends `KernelTestBase` directly instead of `CanvasKernelTestBase`. The rule includes several exception mechanisms: a hardcoded list of known `CanvasKernelTestBase` subclasses like `ComponentSourceTestBase`, allowed alternative base classes from core and contrib like `ConfigEntityValidationTestBase`, and a docblock pattern for tests that document why they cannot use `CanvasKernelTestBase`.

The implementation adds `coding_standards/Canvas/Sniffs/Tests/KernelTestBaseSniff.php` with the sniff logic and `coding_standards/Canvas/ruleset.xml` to register it. The main `phpcs.xml` file includes this ruleset but excludes the `canvas_ai` submodule and one OAuth test to allow those components to maintain their own standards.

Several existing tests were updated: some to extend `CanvasKernelTestBase` instead of `KernelTestBase`, and others to add docblock comments explaining why they cannot use the standard base class. Tests that install Canvas via recipes cannot use `CanvasKernelTestBase` because that base class pre-installs the Canvas module.

## Timeline

- Opened: February 9, 2026
- Committed: February 10, 2026

## Collaboration

Wim Leers created the custom sniff using an LLM to generate the initial implementation, then iterated to improve it. Phenaproxima reviewed the code and requested clarifying documentation on `CanvasKernelTestBase` itself to explain when tests should not extend it, which Leers incorporated nearly verbatim. Phenaproxima noted the LLM-generated code was detectable but pragmatic for a developer unfamiliar with writing PHPCS sniffs. The pair coordinated to increase velocity, with Phenaproxima suggesting future reviewers make small documentation tweaks directly rather than requesting changes.

## Lessons learned

- When introducing a base class that enforces best practices, add a PHPCS sniff to prevent regressions. Automating enforcement removes the burden of repeated human review and ensures consistency across the codebase. *(via wim leers)*
- When requiring a specific base class for tests in a subsystem, document exemptions directly on the test classes themselves and in the PHPCS sniff. This makes the architectural decision visible to future developers and provides a canonical list of legitimate exceptions. *(via phenaproxima, wim leers)*

---

*This summary is AI-generated and may contain errors. Check the [original issue on Drupal.org](https://www.drupal.org/node/3572401) for the full picture. For more digests, see [Drupal Digests](https://github.com/dbuytaert/drupal-digests/).*
