# #3569627: Disable Amazee AI auto-trial provisioning in drupal_cms_ai tests

- **Project:** Drupal CMS
- **Type:** Critical bug report
- **Status:** Fixed
- **Diff:** [949dfb6](https://git.drupalcode.org/project/drupal_cms/-/commit/949dfb6b26c11c6f4e714fa047d2de32d483b909) · +2/-2 prod · +30/-12 test · 6 files
- **Discussion:** [#3569627](https://www.drupal.org/node/3569627) · 4 contributors · 20 comments

## Summary

When Drupal CMS AI tests ran, they tried to create real trial accounts with Amazee.ai by making API calls. These calls timed out after 30 seconds, causing tests to fail. The issue also created unwanted trial accounts on Amazee's systems. The fix detects test environments and skips the trial provisioning step automatically, making tests run faster and preventing spurious account creation.

## Impact

No upgrade or configuration changes required.

## Technical details

The `drupal_cms_ai` recipe includes the `ai_provider_amazeeio` module, which automatically provisions trial API access when applied. The `ensureAmazeeAiAccess` config action triggered `TrialAccountProvisioner` during recipe application, making HTTP requests to `https://api.amazee.ai/auth/generate-trial-access`. In test environments these requests timed out after 30 seconds, failing `ComponentValidationTest`.

The initial fix temporarily skipped the test on CI using `getenv('CI')`. The permanent solution came from upgrading `ai_provider_amazeeio` from version 1.2.6 to 1.2.7. The new version of the module adds environment detection to `TrialAccountProvisioner` that recognizes test contexts and skips provisioning. This happens through a `ai_provider_amazeeio.trial_access_provisioning.disable` container parameter.

The test now validates that provisioning is disabled by checking that output strings like "Waiting for API response" and "Provisioning amazee.ai trial account..." do not appear, and by asserting the container parameter is true. Test runtime dropped from 30+ seconds of timeout waiting to approximately 140 seconds for the full test.

## Timeline

- Opened: January 26, 2026
- First commit: January 26, 2026
- Last commit: February 9, 2026 (13 days later)

## Collaboration

The fix required coordination across two projects. Marcus Johansson identified option #2 from the proposed solutions as the best approach and opened [#3569665](https://www.drupal.org/project/ai_provider_amazeeio/issues/3569665) in the ai_provider_amazeeio module. Dan2k3k4 implemented and released version 1.2.7 with the environment detection. Phenaproxima provided the temporary skip to unblock CI, then re-enabled the test and verified no actual provisioning occurred. This pattern of coordinating fixes across dependent projects while using temporary workarounds to keep tests passing worked well for a critical issue.

## Lessons learned

- When code performs external operations during installation (API calls, account provisioning), it should detect test environments and no-op to avoid side effects. Check for test context at the operation's entry point rather than deep in the stack or via fixture modules. *(via mxr576, marcus_johansson)*

---

*This summary is AI-generated and may contain errors. Check the [original issue on Drupal.org](https://www.drupal.org/node/3569627) for the full picture. For more digests, see [Drupal Digests](https://github.com/dbuytaert/drupal-digests/).*
