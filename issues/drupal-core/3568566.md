# #3568566: Olivero's secondary menus inoperable when authenticated & BigPipe present

- **Project:** Drupal Core
- **Type:** Major bug report
- **Version:** main
- **Status:** Fixed
- **Diff:** [b638f42](https://git.drupalcode.org/project/drupal/-/commit/b638f429a01f3661ae3a358b54179e26b1abb791) 路 +333/-231 路 3 files
- **Discussion:** [#3568566](https://www.drupal.org/node/3568566) 路 5 contributors 路 18 comments

## Summary

Drupal 11.3 introduced a regression where dropdown menus in the Olivero theme stopped working for logged-in users when BigPipe was enabled. The problem occurred because Olivero's navigation JavaScript ran only on initial page load, but BigPipe loads some content asynchronously after the page appears. This meant the menu code never initialized when the navigation arrived late. The fix ensures the menu code runs whenever new content is added to the page, not just once at startup.

## Impact

No upgrade or configuration changes required.

## Technical details

The `second-level-navigation.js` file in Olivero initialized event listeners immediately when the script loaded, querying for menu elements with `document.querySelectorAll()` at the top level. When BigPipe rendered the main menu block asynchronously, those elements did not exist yet, so no listeners attached.

The fix wraps the initialization in a Drupal behavior (`Drupal.behaviors.secondLevelNav`). The `attach()` method uses `once()` to find the primary navigation element and passes it to a new `init(navElement)` function. This function queries for second-level menus within the provided context and attaches all event listeners.

The document-level listeners for Escape key and outside clicks are now wrapped in their own `once('olivero-second-level-nav-document', document)` call. This prevents duplicate handlers if the behavior attaches multiple times. The `secondLevelNavMenus` variable changed from a const initialized at load to a let initialized within `init()`.

The issue was traced to [#3437499](https://www.drupal.org/project/drupal/issues/3437499), which added placeholdering for more blocks in Drupal 11.2. This caused the main menu to render via BigPipe on cache misses, exposing the timing issue that had always existed in Olivero's non-behavior-based code.

## Timeline

- Opened: January 20, 2026
- Committed: February 12, 2026 (22 days later)

## Collaboration

Mike Herchel identified the regression and created the initial patch after mandclu reported the issue on Slack. Lauri Eskola reviewed the code and improved the implementation by renaming variables to avoid shadowing, adding documentation to the `init()` function, and wrapping document-level listeners with `once()` to prevent duplicate handlers. Catch connected the dots back to the placeholdering changes that exposed this timing issue.

## Lessons learned

- When JavaScript modifies DOM elements that may be injected after page load (via BigPipe, AJAX, or similar), wrap initialization code in Drupal.behaviors so it runs both on page load and when new content arrives. Direct execution only runs once and misses dynamically inserted elements. *(via mherchel, lauriii)*
- When attaching document-level event listeners inside a Drupal.behavior that may execute multiple times, wrap them with once() to prevent duplicate handlers from being registered each time the behavior is invoked. *(via lauriii)*

---

*This summary is AI-generated and may contain errors. Check the [original issue on Drupal.org](https://www.drupal.org/node/3568566) for the full picture. For more digests, see [Drupal Digests](https://github.com/dbuytaert/drupal-digests/).*
