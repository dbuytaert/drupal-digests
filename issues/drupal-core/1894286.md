# #1894286: System updates are executed without priority

- **Project:** Drupal Core
- **Type:** Critical bug report
- **Version:** 11.3.x-dev
- **Status:** Fixed
- **Diff:** [b090f8e](https://git.drupalcode.org/project/drupal/-/commit/b090f8e4430cd558ca90b44a1d3f4b842d25402f) · +186/-0 prod · +684/-0 test · 9 files
- **Discussion:** [#1894286](https://www.drupal.org/node/1894286) · 22 contributors · 108 comments

## Summary

Drupal's update system did not always run system module database updates before other modules' updates, even when no explicit dependencies prevented it. This could cause cryptic failures during major or minor version upgrades, particularly when system updates made foundational changes that other updates depended on. The update dependency graph now ensures system updates execute as early as possible while still respecting explicit dependencies declared via `hook_update_dependencies()`. Sites performing upgrades across Drupal versions with many pending updates will now have more reliable update paths.

## Impact

No upgrade or configuration changes required.

## Technical details

The `update_build_dependency_graph()` function in `core/includes/update.inc` now manipulates the dependency graph to prioritize system module updates. It tracks the highest numbered system update and the lowest numbered update for each non-system module.

When there are no explicit dependencies forcing non-system updates before system updates, the code adds edges from the last system update to the first update of every other module. This simple case ensures all system updates run first.

When `hook_update_dependencies()` forces non-system updates before system updates, the code builds an interim graph using `Graph::searchAndSort()`. It examines the paths key for each non-system update to find which system updates depend on it. Non-system updates with no system update dependencies get an edge from the last system update. Non-system updates that must run before a specific system update get an edge from the previous system update, preserving the dependency chain while still running as many system updates as early as possible.

The new `UpdateOrderingTest` unit test provides comprehensive coverage of update ordering scenarios including dependency chains, in-between dependencies, and complex multi-module dependency graphs. The test uses a fixture that implements `hook_update_dependencies()` with configurable return values.

## Timeline

- Opened: January 21, 2013
- Committed: February 16, 2026 (13 years later)

## Collaboration

This issue remained open for over 13 years with 108 comments. hchonov identified reproducible cases where taxonomy updates ran before system updates during 8.4.8 to 8.6.x upgrades and provided early patches with graph manipulation logic. alexpott shepherded the final implementation through multiple iterations, refactoring the approach to use an interim graph object instead of complex recursive processing, and adding comprehensive test coverage. catch and larowlan provided thorough reviews that pushed the code toward clarity and correctness. The persistence across many contributors and the focus on test coverage for such a critical subsystem exemplify the care required for foundational Drupal systems.

## Lessons learned

- When building dependency graphs for ordered execution, implicit dependencies between subsystems can be as important as explicit ones. If framework updates must complete before application code updates run, add edges to enforce ordering even when developers haven't declared dependencies, because the dependency graph algorithm only respects edges, not module roles or semantics. *(via hchonov, alexpott)*
- When a topological sort produces an acceptable but suboptimal ordering, manipulating weights after sorting is fragile. Instead, add missing edges to the dependency graph before sorting so the graph structure itself encodes the desired constraints and the sort algorithm naturally produces the correct order. *(via hchonov, alexpott)*

---

*This summary is AI-generated and may contain errors. Check the [original issue on Drupal.org](https://www.drupal.org/node/1894286) for the full picture. For more digests, see [Drupal Digests](https://github.com/dbuytaert/drupal-digests/).*
