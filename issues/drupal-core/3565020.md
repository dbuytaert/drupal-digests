# #3565020: Set the Drupal\views\ViewsData::$fullyLoaded property to TRUE only when the data is really loaded.

- **Project:** Drupal Core
- **Type:** Major bug report
- **Version:** 11.3.x-dev
- **Status:** Fixed
- **Diff:** [88dc132](https://git.drupalcode.org/project/drupal/-/commit/88dc1323f7f70c425f6a01af75f6fc2988c3672c) · +105/-18 prod · +924/-0 test · 6 files
- **Discussion:** [#3565020](https://www.drupal.org/node/3565020) · 10 contributors · 43 comments

## Summary

Drupal sometimes failed to load Views data correctly when multiple processes tried to load it at the same time using PHP fibers. This caused database errors on pages with Views blocks, especially on multilingual sites. The issue occurred because the system marked data as loaded before it actually finished loading. The fix ensures Views data is fully loaded before marking it complete, and suspends competing processes to let the first one finish.

## Impact

No upgrade or configuration changes required.

## Technical details

The `ViewsData::getData()` method previously set the `$fullyLoaded` property to TRUE at the start of the method, before actually retrieving or building the data. When running inside a fiber that suspended during module hook invocation, a second fiber could enter the method, see `$fullyLoaded` was TRUE, and use empty data arrays.

The fix moves setting `$fullyLoaded` to TRUE until after the data is obtained (either from cache or by building it). A new `$loading` property tracks when data building is in progress. Both `get()` and `getAll()` check this flag at entry. If another fiber is loading data, the current fiber suspends once using `\Fiber::suspend()` to give the original fiber a chance to complete.

This approach mirrors the pattern used in `LocalTaskManager::getLocalTasks()`. It prevents race conditions while also reducing redundant work. Without the fiber suspension check, multiple fibers would build the same data simultaneously. With it, the second fiber waits for the first to complete, avoiding duplicate builds.

The unit tests verify the `$fullyLoaded` property lifecycle using reflection. A new `testConcurrentFiberAccess()` test simulates concurrent fiber execution with four combinations of `get()` and `getAll()` calls, confirming that both fibers receive correct data and no empty cache entries are written.

## Timeline

- Opened: December 29, 2025
- Committed: February 18, 2026 (1 month later)

## Collaboration

dench0 opened the issue with detailed reproduction steps and a clear diagnosis of the race condition in Views data loading. eduardo morales alberti and their team worked on improvements to the test coverage and incorporated feedback about assertion messages. godotislate performed thorough testing against both the original reproduction steps and the test-only job, retargeted the merge request to the correct branch, and pushed for the fiber suspension optimization. berdir suggested the optimization based on their experience implementing the same pattern in LocalTaskManager and opened a follow-up issue for standardizing this approach across core. mariaioann provided production validation, confirming the patch fixed failures that appeared after upgrading from 11.2.10 to 11.3.3.

## Lessons learned

- When a flag tracks asynchronous work completion, set it only after the work succeeds. Setting the flag before the work completes causes race conditions: if the async operation suspends (e.g., in a Fiber), subsequent calls see the flag set and skip initialization, leaving data structures empty or incomplete. *(via dench0, berdir)*
- When cache-loading code can be re-entered during asynchronous execution, check if you are inside a Fiber and suspend once on detecting re-entry. This gives the first caller a chance to complete the work before duplicating the expensive operation, avoiding loading the same data twice. *(via berdir)*

---

*This summary is AI-generated and may contain errors. Check the [original issue on Drupal.org](https://www.drupal.org/node/3565020) for the full picture. For more digests, see [Drupal Digests](https://github.com/dbuytaert/drupal-digests/).*
