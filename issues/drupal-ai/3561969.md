# #3561969: Research Structured Content/JSON:schema form element

- **Project:** Drupal AI
- **Type:** Normal plan
- **Version:** 1.3.x-dev
- **Status:** Fixed
- **Diff:** [ef70da4](https://git.drupalcode.org/project/ai/-/commit/ef70da4272d001d165fe7ee1ad520cb314c10142) · +1582/-18 prod · +386/-0 test · +52/-6 infra · 30 files
- **Discussion:** [#3561969](https://www.drupal.org/node/3561969) · 3 contributors · 19 comments

## Summary

The AI module now includes a dedicated form element for editing JSON schemas. Instead of typing raw JSON or YAML into plain text boxes, users see a code editor with syntax highlighting, line numbers, and immediate feedback when the JSON is malformed. This makes it easier to create structured data configurations for AI agents, API explorers, and other AI features. The editor falls back gracefully to a plain textarea when JavaScript is unavailable.

## Impact

Affects module maintainers.

- **New API:** New `ai_json_schema` form element provides a CodeMirror-based JSON editor with syntax highlighting and real-time validation.

## Technical details

The new `ai_json_schema` form element is built using CodeMirror 6. It is defined in `src/Element/AiJsonSchema.php` and integrates JSON language support via the `@codemirror/lang-json` package. The element renders three child components: a hidden input that carries the form value, a fallback textarea for no-JS scenarios, and a div container where the CodeMirror instance mounts.

When JavaScript loads, the Drupal behavior `aiJsonSchemaEditor` initializes CodeMirror in the container, hides the fallback textarea, and syncs all editor changes back to the hidden input for standard form submission. The editor includes real-time JSON linting via `jsonParseLinter()` and automatically pretty-prints valid JSON on load.

The frontend assets live in `ui/json-schema-editor` and are built using Vite. The build process is integrated into the GitLab CI pipeline and the release tagging script. Built artifacts are excluded from the repository except in tagged releases. The module ships with a new library definition `ai/json_schema_editor` that attaches the JavaScript and CSS.

The `ChatGenerator` plugin in AI API Explorer was updated to use `#type => 'ai_json_schema'` instead of `#type => 'textarea'` for the structured output field. Kernel tests in `AiJsonSchemaElementTest` verify that the element builds the correct render structure, sets default values properly, and handles form submission. A test form at `/admin/config/ai/test-form-elements` demonstrates the editor in action when the AI Test module is enabled.

## Upgrade

Module developers can use the new form element in any form by setting `#type` to `ai_json_schema`:

```php
$form['json_schema'] = [
  '#type' => 'ai_json_schema',
  '#title' => $this->t('JSON Schema'),
  '#description' => $this->t('Enter a valid JSON schema.'),
  '#default_value' => '{"type": "object", "properties": {}}',
];
```

Developers working with the AI module from a Git branch need to build the editor assets manually. Run `cd ui/json-schema-editor && npm install && npm run build` before using features that depend on the JSON schema editor. Tagged releases include the built assets automatically.

## Timeline

- Opened: December 8, 2025
- Committed: February 16, 2026 (2 months later)

## Collaboration

marcus_johansson developed the form element, integrated CodeMirror, created the build tooling, and ensured graceful fallback for no-JS scenarios. The issue notes that AI tools were used for parts of the documentation and test code. a.dmitriiev tested the editor in both the API Explorer and the test form, verified it worked as expected, and updated the GitLab CI job to build the JSON Schema Editor artifacts so they are available during automated testing.

## Lessons learned

- When building custom form elements that rely on JavaScript for an enhanced experience, implement graceful degradation with a functional textarea fallback. If JavaScript fails to load or is disabled, users can still interact with the raw data, preventing the form from becoming unusable. *(via marcus_johansson)*
- When adding frontend build artifacts to a project, exclude the generated dist files from version control by adding them to release scripts. This keeps the repository clean while ensuring production releases include the compiled assets. *(via marcus_johansson)*

---

*This summary is AI-generated and may contain errors. Check the [original issue on Drupal.org](https://www.drupal.org/node/3561969) for the full picture. For more digests, see [Drupal Digests](https://github.com/dbuytaert/drupal-digests/).*
