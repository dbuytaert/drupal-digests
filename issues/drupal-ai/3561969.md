# #3561969: Research Structured Content/JSON:schema form element

- **Project:** Drupal AI
- **Type:** Normal plan
- **Version:** 1.3.x-dev
- **Status:** Fixed
- **Diff:** [ef70da4](https://git.drupalcode.org/project/ai/-/commit/ef70da4272d001d165fe7ee1ad520cb314c10142) · +1582/-18 prod · +386/-0 test · +52/-6 infra · 30 files
- **Discussion:** [#3561969](https://www.drupal.org/node/3561969) · 3 contributors · 20 comments

## Summary

The AI module now provides a reusable JSON schema editor for forms. Instead of writing JSON or YAML in a plain textarea, users get a CodeMirror editor with syntax highlighting, line numbers, and real-time validation that shows errors as they type. The editor automatically formats valid JSON and falls back to a plain textarea when JavaScript is unavailable. This makes it easier to configure structured content for AI agents, ECA rules, and API explorers without memorizing JSON syntax rules.

## Impact

No upgrade or configuration changes required.

## Technical details

The new `ai_json_schema` form element wraps a CodeMirror 6 editor configured for JSON. The `AiJsonSchema` class in `src/Element/AiJsonSchema.php` implements `FormElementBase` and generates three HTML elements: a hidden input that carries the form value, a visible textarea for graceful degradation when JavaScript is disabled, and a container div where CodeMirror attaches.

The JavaScript in `ui/json-schema-editor/src/ai-json-schema.js` uses Drupal behaviors to initialize CodeMirror with `basicSetup`, `json()` language support, and `jsonParseLinter()` for real-time validation. The editor syncs content changes back to the hidden input via an `updateListener`. All three elements share a unique ID through data attributes so the JavaScript can wire them together.

The editor is built with Vite and uses npm packages `codemirror`, `@codemirror/lang-json`, and `@codemirror/lint`. The build artifacts are excluded from version control but included in tagged releases. The CI pipeline now builds the editor alongside other JavaScript assets in the `js_build` job. The `tag-release.sh` script handles versioning and committing the built files for releases.

The `ChatGenerator` plugin in AI API Explorer now uses `#type => 'ai_json_schema'` instead of `#type => 'textarea'` for the structured output field. The test module adds a demonstration form at `/admin/config/ai/test-form-elements` with a kernel test suite that validates the element structure, data attributes, default values, and form submission behavior.

## Timeline

- Opened: December 8, 2025
- Committed: February 16, 2026 (2 months later)

## Collaboration

Marcus Johansson researched frontend libraries for JSON schema editing, evaluated options, and implemented the CodeMirror-based solution with build tooling, graceful fallback, kernel tests, and comprehensive documentation. They transparently noted which parts were AI-generated versus human-written. A.dmitriiev tested both the API Explorer and test form implementations, verified the editor worked as expected, and updated the GitLab CI configuration to ensure the built JavaScript is available during automated testing.

## Lessons learned

- When building a custom form element with JavaScript enhancement, ensure graceful degradation by providing a functional fallback. If JavaScript fails to load or is disabled, the form element should render as a standard input (like a textarea) so the form remains usable. *(via marcus_johansson)*
- When adding JavaScript-enhanced form elements that require build steps, provide clear separation between source code and built artifacts. Exclude large generated files from version control and document the build process so contributors can regenerate the assets locally. *(via marcus_johansson)*

---

*This summary is AI-generated and may contain errors. Check the [original issue on Drupal.org](https://www.drupal.org/node/3561969) for the full picture. For more digests, see [Drupal Digests](https://github.com/dbuytaert/drupal-digests/).*
