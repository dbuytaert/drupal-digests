# #3533079: Introduce AI Agents and tools to create entire page templates using available component entities

- **Project:** Drupal AI
- **Type:** Normal feature request
- **Version:** 1.x-dev
- **Status:** Fixed
- **Diff:** [c616be8](https://git.drupalcode.org/project/canvas/-/commit/c616be88cc1e3075cf322ac01426715d1d8be080) · +886/-200 prod · +569/-6 test · 18 files
- **Discussion:** [#3533079](https://www.drupal.org/node/3533079) · 16 contributors · 107 comments

## Summary

Canvas AI can now generate complete page layouts from a single prompt, including headers, footers, and multiple content sections. Previously, the AI could only add individual components one at a time. Now, users can request "Create a homepage for an ice cream shop with a header and footer" and the AI will assemble an entire page template using available components. Site builders can also describe how different page regions should be used to guide the AI when generating templates for themes with multiple regions like sidebars.

## Impact

No upgrade or configuration changes required.

## Technical details

This introduces the `canvas_template_builder_agent`, a new AI sub-agent within the Canvas AI orchestrator that generates complete page templates by assembling available components into multi-section layouts. The orchestrator prompt was updated to distinguish between incremental changes (delegated to `canvas_page_builder_agent`) and full-page creation requests (delegated to `canvas_template_builder_agent`).

The template builder agent receives context via three tools: `GetComponentContext` for available components, `GetCurrentLayout` for page structure, and the `[canvas_ai:available_regions]` token for region descriptions. It outputs a YAML structure keyed by region name, which the new `SetAIGeneratedTemplateData` function call processes. The `CanvasAiPageBuilderHelper::processSetTemplateDataToolInput()` method converts YAML into operations that the `addNewComponentToLayout` thunk can execute.

A new configuration form at `/admin/config/ai/canvas-ai-theme-region-settings` allows site builders to add descriptions for each enabled page region. These descriptions guide the AI when deciding which components to place in which regions. The `CanvasAiPageBuilderHelper::getAvailableRegions()` method retrieves these descriptions and passes them to the agent.

By default, the template builder generates only page body content in the content region. It creates headers and footers only when explicitly requested and places them in respective regions if available. The `canvas_title_generation_agent` and `canvas_metadata_generation_agent` are automatically invoked when title or description are empty, following the same pattern as the page builder agent.

The polling message system was updated to distinguish agent activities: "Finding components to place" for the page builder and "Designing the page" for the template builder. The prop-setting logic for image props was synchronized between both agents to ensure consistent handling of complex default values. A post-update hook rebuilds routes since several Canvas AI routes changed.

## Timeline

- Opened: June 30, 2025
- Committed: February 12, 2026 (7 months later)

## Collaboration

Akhil Babu developed the feature over seven months, including the agent configuration, YAML processing logic, validation system, and configuration form. He iterated through multiple approaches for handling headers and footers based on feedback, ultimately settling on explicit user control. Marcus Johansson provided extensive prompt engineering review and tested delegation logic between the template and page builder agents, including creating test suites to verify correct agent selection. Narendrar conducted thorough manual testing across multiple iterations, identifying edge cases like duplicate header placement and missing title generation. Tedbow raised important questions about terminology conflicts with Content Templates and pushed for clearer documentation. Jibran completed the final code review and identified the missing post-update hook for route rebuilding before setting to RTBC.

## Lessons learned

- When building AI agents that process complex user requests, separate orchestration logic from domain-specific generation. An orchestrator should delegate to specialized sub-agents (like template builder vs. page builder) based on request intent, allowing each agent to focus on its core responsibility without mixing concerns like validation or metadata generation. *(via akhil babu)*
- When AI agents place components in multi-region layouts, provide region-specific descriptions through configuration so the AI understands the semantic purpose of each region (header, sidebar, footer). This contextual information helps the agent make appropriate placement decisions without hardcoding region logic. *(via akhil babu)*
- When AI generates structured output like page layouts, use YAML as an intermediate format that can be validated before converting to internal data structures. This separation allows validation of AI output independently from the system's rendering logic. *(via akhil babu)*
- When routes are added or URIs are updated in a module, include a post_update hook to rebuild the router cache. Without this, new routes won't be accessible until manual cache clear, causing confusion in production deployments. *(via jibran, akhil babu)*

---

*This summary is AI-generated and may contain errors. Check the [original issue on Drupal.org](https://www.drupal.org/node/3533079) for the full picture. For more digests, see [Drupal Digests](https://github.com/dbuytaert/drupal-digests/).*
