# #3566583: Add Field Widget Actions (FWA) support for text-to-image media generation on the media_library_widget for core Image media

- **Project:** Drupal AI
- **Type:** Normal feature request
- **Version:** 1.3.x-dev
- **Status:** Fixed
- **Diff:** [239ad1f](https://git.drupalcode.org/project/ai/-/commit/239ad1f202aadd5a57bcd7e8df932477b93e6ec8) · +526/-8 prod · +504/-0 test · 12 files
- **Discussion:** [#3566583](https://www.drupal.org/node/3566583) · 7 contributors · 33 comments

## Summary

Content editors can now generate images using AI while editing content. A new action button on media fields lets editors type a prompt and instantly create image media entities without leaving the edit form. This makes it easier to create hero images, teaser graphics, or illustrations for articles using text-to-image AI models. The feature works with the Media Library widget and requires configuring an AI automator for the field.

## Impact

No upgrade or configuration changes required.

## Technical details

This feature adds a new Field Widget Action plugin `TextToImageMediaLibrary` that integrates text-to-image generation with the `media_library_widget`. The plugin extends `AutomatorBaseAction` and targets `entity_reference` fields pointing to media entities with image bundles.

The `isAvailable()` method verifies that the field references media entities and that at least one target bundle uses the image source plugin. The `singleElementFormAlter()` method hides the action button when the field has reached its cardinality limit to prevent validation errors.

The `aiAutomatorsAjax()` handler triggers the automator, collects generated media IDs, and uses AJAX commands to update the Media Library widget's hidden selection field and trigger the update button. The `saveFormValues()` method stores the media IDs in the form array for the AJAX handler to retrieve.

The `TextToMediaImage` base class was updated to make the media type selection required and moved it to the top of the form (weight 4) with improved description text warning about required fields. Documentation was added showing how to configure the automator in both automatic (on save) and manual (Field Widget Action button) modes.

A kernel test `TextToImageMediaFieldWidgetProcessingTest` was added covering both the Field Widget Action path (simulating button clicks) and the direct save processing path (automatic generation on entity save).

## Timeline

- Opened: January 9, 2026
- Committed: February 16, 2026 (1 month later)

## Collaboration

Fago shepherded this feature through multiple iterations, adding comprehensive documentation with step-by-step configuration examples, fixing several UX issues discovered during testing (hidden media type field, missing cardinality checks, button visibility), and adding test coverage. A.dmitriiev reviewed thoroughly, requested documentation improvements, and adapted the tests for the 2.0.x branch to follow the new multi-automator structure. Annmarysruthy provided valuable QA testing confirming the feature worked as expected.

## Lessons learned

- When building Field Widget Actions, implement the isAvailable() method to control when the action appears. If the method is missing, the action may appear in inappropriate contexts (like when a single-value field is already full), leading to validation errors when users try to use it. *(via fago)*
- When implementing a feature that requires specific configuration (like automators + field widget actions), provide documentation with concrete setup examples showing each configuration step. Users cannot effectively use features without understanding how to wire the components together. *(via a.dmitriiev)*

---

*This summary is AI-generated and may contain errors. Check the [original issue on Drupal.org](https://www.drupal.org/node/3566583) for the full picture. For more digests, see [Drupal Digests](https://github.com/dbuytaert/drupal-digests/).*
