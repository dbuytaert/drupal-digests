# #3566583: Add Field Widget Actions (FWA) support for text-to-image media generation on the media_library_widget for core Image media

- **Project:** Drupal AI
- **Type:** Normal feature request
- **Version:** 1.3.x-dev
- **Status:** Fixed
- **Diff:** [239ad1f](https://git.drupalcode.org/project/ai/-/commit/239ad1f202aadd5a57bcd7e8df932477b93e6ec8) · +526/-8 prod · +504/-0 test · 12 files
- **Discussion:** [#3566583](https://www.drupal.org/node/3566583) · 7 contributors · 32 comments

## Summary

Content editors can now generate AI images directly from the Media Library widget while editing content. A new "Text to Image Media Library" button triggers text-to-image automators on demand, creating Media entities and attaching them to fields without saving the entire form. This makes it easier for editors to create teaser images, hero images, or other visual content based on text descriptions during the content creation workflow.

## Impact

No upgrade or configuration changes required.

## Technical details

This adds a new Field Widget Action plugin `TextToImageMediaLibrary` for the `media_library_widget` that integrates with AI Automators' text-to-image capability. The plugin extends `AutomatorBaseAction` and works specifically with entity reference fields targeting media entities.

The `isAvailable()` method ensures the action only appears on media reference fields where at least one target bundle uses the image source plugin. The `singleElementFormAlter()` method respects field cardinality, hiding the button when the field is full to prevent validation errors.

The AJAX handler `aiAutomatorsAjax()` runs the configured automator via `populateAutomatorValues()`, then uses `InvokeCommand` to update the Media Library widget's hidden selection field and trigger its update button. This refreshes the widget display to show the newly generated media entity without a full page reload. The `saveFormValues()` method collects target IDs from the entity field and stores them in the form array for AJAX consumption.

The accompanying `TextToMediaImage` base class was updated to move the media type selector to the top of the form with required validation and improved description text. New kernel test coverage verifies both field widget processing (on-demand) and direct save processing (automatic) paths. Comprehensive documentation with step-by-step configuration instructions was added to the examples directory.

## Timeline

- Opened: January 9, 2026
- Committed: February 16, 2026 (1 month later)

## Collaboration

fago drove the implementation forward, identifying several issues during testing including missing `isAvailable()` implementation, cardinality validation problems, and UI configuration issues. He added the documentation, fixed the button visibility logic, and wrote the kernel tests. a.dmitriiev provided thorough review, requesting documentation with screenshots and configuration examples, then merged the feature to both 1.3.x and 2.0.x branches while adapting tests for the new automator structure introduced in #3535824. annmarysruthy provided early testing confirmation that the feature worked correctly in practice.

## Lessons learned

- When building field widget actions that depend on backend services, implement isAvailable() to check that required services (like automators or providers) are configured before displaying the action to users. Without availability checks, users encounter confusing empty forms or runtime failures. *(via fago)*
- When adding actions to cardinality-limited reference fields, check whether the field has room for new values before displaying the action. Showing actions that trigger validation errors due to cardinality limits creates a poor user experience. *(via fago)*
- When implementing features that require specific configuration steps, provide documentation with concrete examples showing how to configure all dependencies. Include example prompts and context usage patterns so users can adapt the feature to their needs without trial and error. *(via a.dmitriiev)*

---

*This summary is AI-generated and may contain errors. Check the [original issue on Drupal.org](https://www.drupal.org/node/3566583) for the full picture. For more digests, see [Drupal Digests](https://github.com/dbuytaert/drupal-digests/).*
