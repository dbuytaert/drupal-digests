# #3556181: Create a form element for selecting providers

- **Project:** Drupal AI
- **Type:** Normal feature request
- **Version:** 2.0.x-dev
- **Status:** Fixed
- **Diff:** [51d88cc](https://git.drupalcode.org/project/ai/-/commit/51d88cc359b3f56ba1d39c26257b4698c20dd318) · +2549/-91 prod · +966/-0 test · 18 files
- **Discussion:** [#3556181](https://www.drupal.org/node/3556181) · 9 contributors · 44 comments

## Summary

The AI module now provides a standardized form element for selecting AI providers and models. Previously, each module implemented provider selection differently, leading to inconsistent user experiences and duplicated code. The new `ai_provider_configuration` form element offers a single, reusable component that handles provider and model selection, optional advanced configuration, and default provider support. This streamlines development for AI module contributors and creates a consistent interface for site builders configuring AI features across different modules.

## Impact

No upgrade or configuration changes required.

## Technical details

The new `AiProviderConfiguration` form element (`#type => 'ai_provider_configuration'`) consolidates provider selection logic that was previously spread across the `AiProviderFormHelper` service and manual implementations using `getSimpleProviderModelOptions()`. The element accepts an `#operation_type` property (like `chat` or `text_to_image`) and optional configuration properties including `#advanced_config` (to show provider-specific settings), `#default_provider_allowed` (to enable a "Default" option), and `#inline_description` (for contextual help text).

The element uses AJAX to dynamically load provider-specific configuration fields when a provider/model is selected. Configuration fields are generated from the provider's schema via `getAvailableConfiguration()` and properly type-cast using `CastUtility`. The element returns a structured array with `provider`, `model`, and `config` keys.

Pseudo operation types are now centralized in a new `PseudoOperationTypes` utility class. These filtered variants of real operation types (like `chat_with_image_vision`) apply capability filters while mapping to actual operation types for schema loading. The `AiSettingsForm` was refactored to use this utility instead of duplicating the definitions.

The element integrates with the existing `ai.provider_config` schema and the `AiProviderInterface::DEFAULT_MODEL_VALUE` constant. Comprehensive browser tests in `AiProviderConfigurationElementTest` verify AJAX loading, default handling, pseudo operation types, and value structure. Developer documentation in `ai_provider_configuration_element.md` provides usage examples, migration guides from the old patterns, and guidance on saving configuration.

## Timeline

- Opened: November 5, 2025
- Committed: February 16, 2026 (3 months later)

## Collaboration

This feature was developed over several months by abhisekmazumdar, who built the form element and iteratively refined it through extensive testing and review cycles. marcus_johansson provided thorough code reviews, caught edge cases like configuration fields persisting after model changes, and shepherded the issue from concept to completion. breidert contributed a UX improvement by adding the `#inline_description` property after reviewing UX feedback. emma horrell and angela saldaña provided UX review and suggestions that improved the description placement and overall user experience. jibran conducted code review that helped improve code quality. The issue involved careful collaboration between developers, UX reviewers, and the module maintainer to create a reusable component that will benefit the entire Drupal AI ecosystem.

## Lessons learned

- When building reusable form elements that appear in multiple contexts, allow titles and descriptions to be configurable by implementers rather than hardcoding them. A form element used in different contexts (e.g., selecting models for chat vs. speech-to-text) needs contextual labels to remain meaningful to end users. *(via marcus_johansson)*
- When creating form elements with AJAX callbacks that update displayed fields, ensure that field metadata (like descriptions) is preserved after the AJAX response. Field metadata can be lost during AJAX operations if not explicitly handled, leaving users without necessary context. *(via abhisekmazumdar)*
- When a form element delegates to a 'default' or 'inherited' option, hide advanced configuration fields for that option. Showing configuration fields when defaults are active creates confusion about whether changes will override system-wide settings. *(via marcus_johansson)*

---

*This summary is AI-generated and may contain errors. Check the [original issue on Drupal.org](https://www.drupal.org/node/3556181) for the full picture. For more digests, see [Drupal Digests](https://github.com/dbuytaert/drupal-digests/).*
